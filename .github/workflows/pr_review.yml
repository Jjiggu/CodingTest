name: PR Discord Notification

on:
  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL = ${{ secrets.DISCORD_WEBHOOK_URL }}")

        run: |
          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          prTitle="${{ github.event.pull_request.title }}"
          prUser="${{ github.event.pull_request.user.login }}"
          prAction="${{ github.event.action }}"
          prUrl="${{ github.event.pull_request.html_url }}"
          prMerged="${{ github.event.pull_request.merged }}"

          if [ "$prAction" == "opened" ]; then
            MESSAGE="**ìƒˆë¡œìš´ PRì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ğŸ“¢**
            - PR ì œëª©: ${prTitle}
            - ë“±ë¡í•œ ì‚¬ëŒ : ${prUser}
            - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° : [í´ë¦­](${prUrl})"
            
          elif [ "$prAction" == "closed" ] && [ "$prMerged" == "true" ]; then
            MESSAGE="**PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰**
            - PR ì œëª©: ${prTitle}
            - ë“±ë¡í•œ ì‚¬ëŒ : ${prUser}
            - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° : [í´ë¦­](${prUrl})"
            
          elif [ "$prAction" == "closed" ]; then
            MESSAGE="- PR ì œëª©: ${prTitle}
          - ë“±ë¡í•œ ì‚¬ëŒ : ${prUser}
          - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° : [í´ë¦­](${prUrl})"
               
          elif [ "$prAction" == "reopened" ]; then
            MESSAGE="**PRì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤! ğŸ”**
            - PR ì œëª©: ${prTitle}
            - ë“±ë¡í•œ ì‚¬ëŒ : ${prUser}
            - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° : [í´ë¦­](${prUrl})"
          else
            MESSAGE="â“ ì•Œ ìˆ˜ ì—†ëŠ” PR ì´ë²¤íŠ¸: **${prTitle}** by ${prUser}. **[í´ë¦­](${prUrl})**"
          fi

          # ë””ìŠ¤ì½”ë“œ ë´‡ì˜ ì‚¬ìš©ì ì´ë¦„ê³¼ ì•„ë°”íƒ€ URL ì„¤ì •
          USERNAME="ì›…? ì–´ì—‰..? ì´ê²Œ ë­ì—¬..! PRì´ì–ì•„..?"
          AVATAR_URL="https://i.ibb.co/dQKDmNj/test.jpg"  # ì›í•˜ëŠ” ì•„ë°”íƒ€ ì´ë¯¸ì§€ URLë¡œ ë³€ê²½í•˜ì„¸ìš”

          # JSON í˜•ì‹ìœ¼ë¡œ ë©”ì‹œì§€ êµ¬ì„±
          DATA=$(jq -n \
            --arg content "$MESSAGE" \
            --arg username "$USERNAME" \
            --arg avatar_url "$AVATAR_URL" \
            '{content: $content, username: $username, avatar_url: $avatar_url}')

          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H 'Content-Type: application/json' -d "$DATA" "DISCORD_WEBHOOK_URL")

          # ì‘ë‹µ ì½”ë“œ í™•ì¸
          if [ "$RESPONSE" -ne 204 ]; then
            echo "Failed to send Discord notification. HTTP Status Code: $RESPONSE"
            exit 1
          fi

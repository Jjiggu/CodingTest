name: PR Discord Notification

on:
  pull_request:
    types: [opened, closed, reopened]

env:
  USERNAME: "ì›…? ì–´ì—‰..? ì´ê²Œ ë­ì—¬..! PRì´ì–ì•„..?"
  AVATAR_URL: "https://i.ibb.co/dQKDmNj/test.jpg"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Assign Random Reviewer
        id: assign-reviewer
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        uses: actions/github-script@v6
        env:
          REVIEWER_MAPPING: ${{ secrets.REVIEWER_MAPPING }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const mappingJson = process.env.REVIEWER_MAPPING;
            let githubToDiscordMap;
            try {
              githubToDiscordMap = JSON.parse(mappingJson);
            } catch (error) {
              throw new Error('Invalid JSON in REVIEWER_MAPPING secret.');
            }
            
            // ë¦¬ë·°ì–´ ëª©ë¡ì„ ë°°ì—´ë¡œ ì •ì˜ (í‚¤ ë¦¬ìŠ¤íŠ¸)
            const allReviewers = Object.keys(githubToDiscordMap);

            // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // PR ì‘ì„±ì
            const prAuthor = pullRequest.user.login;

            // ë¦¬ë·°ì–´ ëª©ë¡ì—ì„œ PR ì‘ì„±ì ì œì™¸
            const reviewers = allReviewers.filter(reviewer => reviewer.toLowerCase() !== prAuthor.toLowerCase());

            if (reviewers.length === 0) {
              throw new Error('No valid reviewers available (all reviewers are PR authors).');
            }

            // ë¦¬ë·°ì–´ ëª©ë¡ì—ì„œ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒ
            const randomReviewer = reviewers[Math.floor(Math.random() * reviewers.length)];

            // ì´ë¯¸ ë¦¬ë·°ì–´ê°€ í• ë‹¹ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (pullRequest.requested_reviewers.length === 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: [randomReviewer]
              });
              console.log(`ë¦¬ë·°ì–´ ${randomReviewer}ê°€ PR #${pullRequest.number}ì— í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              
              // Discord ID ê°€ì ¸ì˜¤ê¸°
              const discordId = githubToDiscordMap[randomReviewer];
              if (!discordId) {
                throw new Error(`Discord ID not found for GitHub user: ${randomReviewer}`);
              }

              // ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
              core.setOutput('reviewer', randomReviewer);
              core.setOutput('discord_id', discordId);
            } else {
              const existingReviewer = pullRequest.requested_reviewers[0].login;
              console.log(`ì´ë¯¸ ë¦¬ë·°ì–´ ${existingReviewer}ê°€ í• ë‹¹ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
              
              // Discord ID ê°€ì ¸ì˜¤ê¸°
              const discordId = githubToDiscordMap[existingReviewer];
              if (!discordId) {
                throw new Error(`Discord ID not found for GitHub user: ${existingReviewer}`);
              }

              // ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
              core.setOutput('reviewer', existingReviewer);
              core.setOutput('discord_id', discordId);
            }
            
            

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

        run: |
          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          prTitle="${{ github.event.pull_request.title }}"
          prUser="${{ github.event.pull_request.user.login }}"
          prAction="${{ github.event.action }}"
          prUrl="${{ github.event.pull_request.html_url }}"
          prMerged="${{ github.event.pull_request.merged }}"
          prActor="${{ github.actor }}"  
          prReviewer="${{ steps.assign-reviewer.outputs.reviewer }}"
          prReviewerDiscordID="${{ steps.assign-reviewer.outputs.discord_id }}"

          if [ "$prAction" == "opened" ]; then
            MESSAGE="**ğŸ“¢ ìƒˆë¡œìš´ PRì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!**
          - <@${prReviewerDiscordID}> ë‹˜ ë¦¬ë·°ì–´ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!! ğŸ™
          - PR ì œëª© : ${prTitle}
          - ë“±ë¡í•œ ì‚¬ëŒ : ${prUser}
          - ë¦¬ë·°ì–´ : <@${prReviewerDiscordID}>
          - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° >> [Click](${prUrl})"
                
          elif [ "$prAction" == "closed" ] && [ "$prMerged" == "true" ]; then
            MESSAGE="**ğŸ‰ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!**
          - PR ì œëª© : ${prTitle}
          - ì‘ì—… ìˆ˜í–‰ì : ${prActor}
          - PR í™•ì¸í•˜ê¸° >> [Click](${prUrl})"
                
          elif [ "$prAction" == "closed" ]; then
            MESSAGE="**ğŸš¨ PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤!**
          - PR ì œëª© : ${prTitle}
          - ì‘ì—… ìˆ˜í–‰ì : ${prActor}
          - PR í™•ì¸í•˜ê¸° >> [Click](${prUrl})"
                
          elif [ "$prAction" == "reopened" ]; then
            MESSAGE="**ğŸ” PRì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤!**
          - <@${prReviewerDiscordID}> ë‹˜ ë¦¬ë·°ì–´ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!! ğŸ™
          - PR ì œëª© : ${prTitle}
          - ì‘ì—… ìˆ˜í–‰ì : ${prActor}
          - ë¦¬ë·°ì–´ : <@${prReviewerDiscordID}>
          - ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸° >> [Click](${prUrl})"
                
          else
           MESSAGE="â“ ì•Œ ìˆ˜ ì—†ëŠ” PR ì´ë²¤íŠ¸: **${prTitle}** by ${prUser}. **[í´ë¦­](${prUrl})**"
          fi
          
          # JSON í˜•ì‹ìœ¼ë¡œ ë©”ì‹œì§€ êµ¬ì„±
          DATA=$(jq -n \
          --arg content "$MESSAGE" \
          --arg username "$USERNAME" \
          --arg avatar_url "$AVATAR_URL" \
          '{content: $content, username: $username, avatar_url: $avatar_url}')

          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H 'Content-Type: application/json' -d "$DATA" "$DISCORD_WEBHOOK_URL")

          # ì‘ë‹µ ì½”ë“œ í™•ì¸
          if [ "$RESPONSE" -ne 204 ]; then
            echo "Failed to send Discord notification. HTTP Status Code: $RESPONSE"
            exit 1
          fi

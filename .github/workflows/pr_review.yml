name: PR Discord Notification

on:
  pull_request:
    types: [opened, closed, reopened]

env:
  USERNAME: "웅? 어엉..? 이게 뭐여..! PR이잖아..?"
  AVATAR_URL: "https://i.ibb.co/dQKDmNj/test.jpg"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: pick_random_reviewer
        id: assign-reviewer
        if: github.event.action == 'opened'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewers = ['kjchoi1997', 'jymin99', 'Jjiggu'];
            const randomReviewer = reviewers[Math.floor(Math.random() * reviewers.length)];
            
            const { data: pullRequest } = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            if (pullRequest.requested_reviewers.length === 0) {
              await github.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: [randomReviewer]
              });
              console.log(`리뷰어 ${randomReviewer}가 PR ${pullRequest.number}에 할당되었습니다.`);
              return { reviewer: randomReviewer };
            } else {
              console.log('이미 리뷰어가 할당되어 있습니다.');
            return { reviewer: pullRequest.requested_reviewers[0].login };
            }


      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

        run: |
          # PR 정보 가져오기
          prTitle="${{ github.event.pull_request.title }}"
          prUser="${{ github.event.pull_request.user.login }}"
          prAction="${{ github.event.action }}"
          prUrl="${{ github.event.pull_request.html_url }}"
          prMerged="${{ github.event.pull_request.merged }}"
          prActor="${{ github.actor }}"  
          prReviewer="${{ steps.assign-reviewer.outputs.reviewer }}"

          if [ "$prAction" == "opened" ]; then
            MESSAGE="**📢 새로운 PR이 도착했습니다!**
          - PR 제목 : ${prTitle}
          - 등록한 사람 : ${prUser}
          - @${prReviewer}님 리뷰어로 할당되었습니다!! 🙏
          - 리뷰하러 가기 : [클릭](${prUrl})"
            
          elif [ "$prAction" == "closed" ] && [ "$prMerged" == "true" ]; then
            MESSAGE="**🎉 PR이 머지되었습니다!**
          - PR 제목 : ${prTitle}
          - 작업 수행자 : ${prActor}
          - PR 확인하기 : [클릭](${prUrl})"
            
          elif [ "$prAction" == "closed" ]; then
            MESSAGE="**🚨 PR이 닫혔습니다!**
          - PR 제목 : ${prTitle}
          - 작업 수행자 : ${prActor}
          - PR 확인하기 : [클릭](${prUrl})"
               
          elif [ "$prAction" == "reopened" ]; then
            MESSAGE="**🔎 PR이 다시 열렸습니다!**
          - PR 제목 : ${prTitle}
          - 작업 수행자 : ${prActor}
          - 리뷰하러 가기 : [클릭](${prUrl})"
          else
            MESSAGE="❓ 알 수 없는 PR 이벤트: **${prTitle}** by ${prUser}. **[클릭](${prUrl})**"
          fi

          # JSON 형식으로 메시지 구성
          DATA=$(jq -n \
            --arg content "$MESSAGE" \
            --arg username "$USERNAME" \
            --arg avatar_url "$AVATAR_URL" \
            '{content: $content, username: $username, avatar_url: $avatar_url}')

          # Discord 웹훅으로 메시지 전송
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H 'Content-Type: application/json' -d "$DATA" "$DISCORD_WEBHOOK_URL")

          # 응답 코드 확인
          if [ "$RESPONSE" -ne 204 ]; then
            echo "Failed to send Discord notification. HTTP Status Code: $RESPONSE"
            exit 1
          fi
